const textutil = require('./../game_logic/textutil.js');

/**
 * Applies this patch to the map code
 * @param {MapCodeData} mapCode The map code data instance
 * @param {string[]} text The text data instance
 */
function apply(mapCode, text) {
    applyKandorean(mapCode[1619]);
    applyMadra(mapCode[1625]);
    applyGaroh(mapCode[1631]);
    applyAlhafra(mapCode[1640]);
    applyBriggs(mapCode[1641]);
    applyKibombo(mapCode[1648]);
    applyJupiterAerie(mapCode[1701]);

    //Set text lines for battle prompts
    textutil.writeLine(text, 0x1B67, "Fight Briggs?\x1E");
    textutil.writeLine(text, 0x2ACD, "Fight Agatio and Karst?\x1E");
}

/**
 * Writes an array of bytes into the map code, overwriting existing data
 * @param {byte[]} mapCode The binary map code data
 * @param {number} offset The position to start writing at
 * @param {byte[]} data The data to write
 */
function applyMapCode(mapCode, offset, data) {
    for (var i = 0; i < data.length; ++i) {
        mapCode[offset++] = data[i];
    }
}

/**
 * Applies cutscene skip to Kandorean Temple
 * @param {MapCodeEntry} mapCode
 */
function applyKandorean(mapCode) {
    mapCode[0] = true;
    
    // ASM for skipping the Master Poi cutscene after taking the item
    applyMapCode(mapCode[1], 0x23E8, [0x20, 0xB5, 0x0, 0x20, 0x02, 0xF0, 0xC0, 0xFF, 0x80, 0x20, 0x80, 0x4, 0x5, 0x0, 0xCA, 0x21, 0x9, 
        0x2, 0xBB, 0x31, 0x89, 0x0, 0x40, 0x18, 0xE2, 0x21, 0x9, 0x2, 0xAC, 0x31, 0x6D, 0x18, 0x0, 0x28, 0x2, 0xD0, 0x3, 0x21, 0x2, 0xF0,
        0x8F, 0xFF, 0xC6, 0x20, 0x0, 0x21, 0x2, 0xF0, 0xDB, 0xFE, 0x28, 0x68, 0x0, 0x28, 0x1, 0xD0, 0x2, 0xF0, 0x92, 0xFE, 0xC, 0x20, 
        0x4, 0x21, 0x2, 0xF0, 0xE, 0xFF, 0x80, 0x20, 0x0, 0x1, 0x4A, 0x30, 0x2, 0xF0, 0x71, 0xFE, 0x20, 0xBD]);

    // ASM for skipping the cutscenes with Kraden outside
    applyMapCode(mapCode[1], 0x2336, [0x2, 0xB0, 0x0, 0xBD]);
    mapCode[1][0x6007] = 0x12;
}

/**
 * Applies cutscene skip to Madra
 * @param {MapCodeEntry} mapCode 
 */
function applyMadra(mapCode) {
    mapCode[0] = true;

    //ASM for skipping the mushroom scenes
    applyMapCode(mapCode[1], 0x102E, [0xD, 0xE0]);
    applyMapCode(mapCode[1], 0x1090, [0xB0, 0xE0]);
    applyMapCode(mapCode[1], 0x1202, [0x2, 0xE0]);
    applyMapCode(mapCode[1], 0x1218, [0x17, 0xE0]);
    applyMapCode(mapCode[1], 0x1258, [0x10, 0xE0]);
    applyMapCode(mapCode[1], 0x1286, [0x31, 0xE0]);
    mapCode[1][0x1252] = 0x19;
}

/**
 * Applies cutscene skip to Garoh
 * @param {MapCodeEntry} mapCode 
 */
function applyGaroh(mapCode) {
    mapCode[0] = true;

    //ASM for skipping the Master Maha daytime cutscene
    mapCode[1][0x389C] = 0x48;
    applyMapCode(mapCode[1], 0x38A2, [0x52, 0x4]);
    applyMapCode(mapCode[1], 0x38B4, [0x3, 0xE0]);
    applyMapCode(mapCode[1], 0x38DC, [0x26, 0xE0]);
    applyMapCode(mapCode[1], 0x3938, [0x32, 0xE0]);
    applyMapCode(mapCode[1], 0x39B0, [0x20, 0x20, 0x0, 0x3, 0xCA, 0x30, 0x0, 0x2, 0xB3, 0x30, 0x0, 0x47]);
    applyMapCode(mapCode[1], 0x4B7A, [0x18, 0xE1]);
    applyMapCode(mapCode[1], 0x4DF6, [0x80, 0xE1]);
}

/**
 * Applies cutscene skip to (Eastern) Alhafra
 * @param {MapCodeEntry} mapCode 
 */
function applyAlhafra(mapCode) {
    mapCode[0] = true;

    //ASM for skipping the mayor cutscene after Bursting the rock
    applyMapCode(mapCode[1], 0x204A, [0x90, 0x25, 0x2D, 0x1, 0x68, 0x1D, 0x2, 0xF0, 0xD8, 0xFC, 0xF, 0x35, 0x28,
        0x1C, 0x2, 0xF0, 0xD4, 0xFC, 0x7F, 0x35, 0x28, 0x1C, 0x2, 0xF0, 0xD0, 0xFC, 0x20, 0xBD]);
    applyMapCode(mapCode[1], 0x2A0A, [0xE0, 0xBD]);
}

/**
 * Applies cutscene skip to the Briggs battle in Alhafra
 * @param {MapCodeEntry} mapCode
 */
function applyBriggs(mapCode) {
    mapCode[0] = true;

    // ASM for skipping the Briggs pre-battle cutscene
    applyMapCode(mapCode[1], 0x4F4, [0x0, 0xB5, 0x0, 0x20, 0x2, 0xF0, 0xA2, 0xFE, 0x4, 0x20, 0x0, 0x21, 0x0, 0x22, 0x0, 0x23, 0x2, 0xF0,
        0xA8, 0xFE, 0x1B, 0x20, 0x0, 0x2, 0x67, 0x30, 0x5, 0x21, 0x2, 0xF0, 0xC6, 0xFE, 0x4, 0x20, 0x0, 0x21, 0x2, 0xF0, 0x12, 0xFE, 0x0,
        0x28, 0x6, 0xD0, 0x4, 0x20, 0x0, 0x21, 0x10, 0x22, 0x52, 0x42, 0x2, 0xF0, 0x96, 0xFE, 0xE, 0xE0, 0x80, 0x23, 0xDB, 0x2, 0x9,
        0x33, 0xDB, 0x1, 0xB, 0x33, 0x2, 0x22, 0x1A, 0x70, 0x63, 0x20, 0x63, 0x21, 0x2, 0xF0, 0x72, 0xFE, 0xA, 0x20, 0x1, 0x21, 0x2,
        0xF0, 0x6A, 0xFE, 0x0, 0xBD, 0x0, 0xBD]);

    // ASM for skipping the Briggs post-battle cutscene
    applyMapCode(mapCode[1], 0x292, [0xF5, 0x0, 0xF5, 0x0]);

    // Updates function table
    applyMapCode(mapCode[1], 0x32A4, [0x41, 0x80, 0x3]);
}

/**
 * Applies cutscene skip to the Kibombo cutscenes
 * @param {MapCodeEntry} mapCode 
 */
function applyKibombo(mapCode) {
    mapCode[0] = true;

    //ASM for skipping the cutscene where Piers joins
    applyMapCode(mapCode[1], 0x131A, [0x20, 0x4D, 0x99, 0x22, 0x12, 0x2, 0x28, 0x68, 0x1F, 0x49, 0x99, 0x32, 0x4, 0xF0, 0xD1, 0xFB, 0x99, 
        0x22, 0x12, 0x2, 0x1C, 0x49, 0x99, 0x32, 0x7, 0x20, 0x4, 0xF0, 0xCA, 0xFB, 0x15, 0x49, 0x7, 0x20, 0x4, 0xF0, 0xCA, 0xFB, 0x14, 0x49, 
        0x28, 0x68, 0x4, 0xF0, 0xCE, 0xFB, 0x28, 0x68, 0x0, 0x21, 0x0, 0x22, 0x4, 0xF0, 0x11, 0xFC, 0xCC, 0x21, 0xCC, 0x22, 0x9, 0x2, 0xD2, 
        0x1, 0x7, 0x20, 0xCC, 0x31, 0x66, 0x32, 0x4, 0xF0, 0xB4, 0xFB, 0xC, 0x49, 0x7, 0x20, 0x4, 0xF0, 0xBC, 0xFB, 0x80, 0x20, 0x0, 0x1, 0xF4, 
        0x30, 0x4, 0xF0, 0x4F, 0xFB, 0x90, 0x20, 0x0, 0x1, 0x2E, 0x30, 0x4, 0xF0, 0x4A, 0xFB, 0x7, 0x20, 0x1, 0x21, 0x4, 0xF0, 0x92, 0xFB, 0x4, 
        0xF0, 0x80, 0xFB, 0x20, 0xBD, 0x0, 0x0, 0xEC, 0xDE, 0x0, 0x2, 0x88, 0xDE, 0x0, 0x2, 0xE0, 0xDF, 0x0, 0x2, 0x54, 0x4, 0x0, 0x2, 0x33, 
        0x33, 0x1, 0x0]);
}

/**
 * Applies cutscene skip to the Jupiter Lighthouse aerie
 * @param {MapCodeEntry} mapCode
 */
function applyJupiterAerie(mapCode) {
    mapCode[0] = true;

    // ASM for skipping the Agatio & Karst battle cutscene
    applyMapCode(mapCode[1], 0x65C, [0x20, 0xB5, 0xA0, 0x20, 0x0, 0x1, 0x23, 0x30, 0x5, 0xF0, 0x62, 0xF8, 0x0, 0x28, 0x55, 0xD0, 0x0, 
        0x20, 0x5, 0xF0, 0x89, 0xF9, 0x4, 0x20, 0x0, 0x21, 0x0, 0x22, 0x5, 0xF0, 0x94, 0xF9, 0xAB, 0x20, 0x80, 0x1, 0x0D, 0x30, 0x5, 0x21, 
        0x5, 0xF0, 0xA2, 0xF8, 0x4, 0x20, 0x0, 0x21, 0x5, 0xF0, 0xCA, 0xF8, 0x0, 0x28, 0x0F, 0xD0, 0x80, 0x22, 0x51, 0x2, 0x12, 0x2, 0x4, 
        0x20, 0x5, 0xF0, 0xCA, 0xF8, 0x80, 0x21, 0x89, 0x0, 0x89, 0x1C, 0x9A, 0x22, 0x52, 0x0, 0x52, 0x1C, 0x4, 0x20, 0x5, 0xF0, 0xDD, 
        0xF8, 0x31, 0xE0, 0xA0, 0x20, 0x5, 0x1, 0x28, 0x0, 0x21, 0x30, 0x5, 0xF0, 0x3A, 0xF8, 0x8D, 0x20, 0x0, 0x1, 0x0F, 0x30, 0x5, 0xF0, 
        0x35, 0xF8, 0x28, 0x0, 0x25, 0x30, 0x5, 0xF0, 0x35, 0xF8, 0x80, 0x20, 0x45, 0x0, 0x28, 0x0, 0x61, 0x30, 0x5, 0xF0, 0x2F, 0xF8, 
        0x28, 0x0, 0x44, 0x30, 0x5, 0xF0, 0x2B, 0xF8, 0xFB, 0x25, 0x80, 0x20, 0x40, 0x2, 0x40, 0x19, 0x80, 0x22, 0x92, 0x4, 0x94, 0x21, 
        0xC9, 0x0, 0x89, 0x18, 0x8, 0x60, 0x2, 0x20, 0x15, 0x39, 0x8, 0x70, 0x28, 0x0, 0x5, 0x21, 0x5, 0xF0, 0x1E, 0xF9, 0x28, 0x0, 0x5, 
        0x21, 0x5, 0xF0, 0x1E, 0xF9, 0x0D, 0x20, 0x7, 0x21, 0x5, 0xF0, 0x12, 0xF9, 0x20, 0xBD]);
}

module.exports = {apply};

/**
 * @typedef {[boolean, byte[]]} MapCodeEntry
 * @typedef {Object.<string, MapCodeEntry>} MapCodeData
 */