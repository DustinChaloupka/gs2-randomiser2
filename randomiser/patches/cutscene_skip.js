const textutil = require('./../game_logic/textutil.js');

/**
 * Applies this patch to the map code
 * @param {{}} mapCode The map code data instance
 * @param {{}} text The text data instance
 */
function apply(mapCode, text) {
    applyKandorean(mapCode[1619]);
    applyBriggs(mapCode[1641]);
    applyJupiterAerie(mapCode[1701]);

    //Set text lines for battle prompts
    textutil.writeLine(text, 0x1B67, "Fight Briggs?\x1E");
    textutil.writeLine(text, 0x2ACD, "Fight Agatio and Karst?\x1E");
}

/**
 * Writes an array of bytes into the map code, overwriting existing data
 * @param {byte[]} mapCode The binary map code data
 * @param {number} offset The position to start writing at
 * @param {byte[]} data The data to write
 */
function applyMapCode(mapCode, offset, data) {
    for (var i = 0; i < data.length; ++i) {
        mapCode[offset++] = data[i];
    }
}

/**
 * Applies cutscene skip to Kandorean Temple
 */
function applyKandorean(mapCode) {
    mapCode[0] = true;
    
    // ASM for skipping the Master Poi cutscene after taking the item
    applyMapCode(mapCode[1], 0x23E8, [0x20, 0xB5, 0x0, 0x20, 0x02, 0xF0, 0xC0, 0xFF, 0x80, 0x20, 0x80, 0x4, 0x5, 0x0, 0xCA, 0x21, 0x9, 
        0x2, 0xBB, 0x31, 0x89, 0x0, 0x40, 0x18, 0xE2, 0x21, 0x9, 0x2, 0xAC, 0x31, 0x6D, 0x18, 0x0, 0x28, 0x2, 0xD0, 0x3, 0x21, 0x2, 0xF0,
        0x8F, 0xFF, 0xC6, 0x20, 0x0, 0x21, 0x2, 0xF0, 0xDB, 0xFE, 0x28, 0x68, 0x0, 0x28, 0x1, 0xD0, 0x2, 0xF0, 0x92, 0xFE, 0xC, 0x20, 
        0x4, 0x21, 0x2, 0xF0, 0xE, 0xFF, 0x80, 0x20, 0x0, 0x1, 0x4A, 0x30, 0x2, 0xF0, 0x71, 0xFE, 0x20, 0xBD]);

    // Flips flag requirement for the event with Kraden outside so it won't play
    mapCode[1][0x6007] = 0x12;
}

/**
 * Applies cutscene skip to the Briggs battle in Alhafra
 */
function applyBriggs(mapCode) {
    mapCode[0] = true;

    // ASM for skipping the Briggs pre-battle cutscene
    applyMapCode(mapCode[1], 0x4F4, [0x0, 0xB5, 0x0, 0x20, 0x2, 0xF0, 0xA2, 0xFE, 0x4, 0x20, 0x0, 0x21, 0x0, 0x22, 0x0, 0x23, 0x2, 0xF0,
        0xA8, 0xFE, 0x1B, 0x20, 0x0, 0x2, 0x67, 0x30, 0x5, 0x21, 0x2, 0xF0, 0xC6, 0xFE, 0x4, 0x20, 0x0, 0x21, 0x2, 0xF0, 0x12, 0xFE, 0x0,
        0x28, 0x6, 0xD0, 0x4, 0x20, 0x0, 0x21, 0x10, 0x22, 0x52, 0x42, 0x2, 0xF0, 0x96, 0xFE, 0xE, 0xE0, 0x80, 0x23, 0xDB, 0x2, 0x9,
        0x33, 0xDB, 0x1, 0xB, 0x33, 0x2, 0x22, 0x1A, 0x70, 0x63, 0x20, 0x63, 0x21, 0x2, 0xF0, 0x72, 0xFE, 0xA, 0x20, 0x1, 0x21, 0x2,
        0xF0, 0x6A, 0xFE, 0x0, 0xBD, 0x0, 0xBD]);

    // ASM for skipping the Briggs post-battle cutscene
    applyMapCode(mapCode[1], 0x292, [0xF5, 0x0, 0xF5, 0x0]);

    // Updates function table
    applyMapCode(mapCode[1], 0x32A4, [0x41, 0x80, 0x3]);
}

/**
 * Applies cutscene skip to the Jupiter Lighthouse aerie
 */
function applyJupiterAerie(mapCode) {
    mapCode[0] = true;

    // ASM for skipping the Agatio & Karst battle cutscene
    applyMapCode(mapCode[1], 0x65C, [0x20, 0xB5, 0xA0, 0x20, 0x0, 0x1, 0x23, 0x30, 0x5, 0xF0, 0x62, 0xF8, 0x0, 0x28, 0x55, 0xD0, 0x0, 
        0x20, 0x5, 0xF0, 0x89, 0xF9, 0x4, 0x20, 0x0, 0x21, 0x0, 0x22, 0x5, 0xF0, 0x94, 0xF9, 0xAB, 0x20, 0x80, 0x1, 0x0D, 0x30, 0x5, 0x21, 
        0x5, 0xF0, 0xA2, 0xF8, 0x4, 0x20, 0x0, 0x21, 0x5, 0xF0, 0xCA, 0xF8, 0x0, 0x28, 0x0F, 0xD0, 0x80, 0x22, 0x51, 0x2, 0x12, 0x2, 0x4, 
        0x20, 0x5, 0xF0, 0xCA, 0xF8, 0x80, 0x21, 0x89, 0x0, 0x89, 0x1C, 0x9A, 0x22, 0x52, 0x0, 0x52, 0x1C, 0x4, 0x20, 0x5, 0xF0, 0xDD, 
        0xF8, 0x31, 0xE0, 0xA0, 0x20, 0x5, 0x1, 0x28, 0x0, 0x21, 0x30, 0x5, 0xF0, 0x3A, 0xF8, 0x8D, 0x20, 0x0, 0x1, 0x0F, 0x30, 0x5, 0xF0, 
        0x35, 0xF8, 0x28, 0x0, 0x25, 0x30, 0x5, 0xF0, 0x35, 0xF8, 0x80, 0x20, 0x45, 0x0, 0x28, 0x0, 0x61, 0x30, 0x5, 0xF0, 0x2F, 0xF8, 
        0x28, 0x0, 0x44, 0x30, 0x5, 0xF0, 0x2B, 0xF8, 0xFB, 0x25, 0x80, 0x20, 0x40, 0x2, 0x40, 0x19, 0x80, 0x22, 0x92, 0x4, 0x94, 0x21, 
        0xC9, 0x0, 0x89, 0x18, 0x8, 0x60, 0x2, 0x20, 0x15, 0x39, 0x8, 0x70, 0x28, 0x0, 0x5, 0x21, 0x5, 0xF0, 0x1E, 0xF9, 0x28, 0x0, 0x5, 
        0x21, 0x5, 0xF0, 0x1E, 0xF9, 0x0D, 0x20, 0x7, 0x21, 0x5, 0xF0, 0x12, 0xF9, 0x20, 0xBD]);
}

module.exports = {apply};